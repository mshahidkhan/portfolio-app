<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="router-root-node">
  <template>
    <content></content>
  </template>
  <script>
    Polymer({
      is: 'router-root-node'
    })
  </script>
</dom-module>

<dom-module id="route-link">
  <template>
   <style>
      .route-link{
         cursor: pointer;
      }
   </style>
   <div class='route-link'>
       {{value}}
      <content></content>
   </div>
  </template>
  <script>
    Polymer({
      is: 'route-link',
      properties:{
         route: String,
         params: Object,
         queryParams: Object,
         value: Object
      },
      listeners: {
        'click': 'handleClick'
      },

      handleClick: function() {
        Router.go(this.route,this.params,this.queryParams)
      }
    });
  </script>
</dom-module>
<script>
/*****************************************************

******************************************************/
"use strict"

function Router(){
   var _routes = {};
   var _notFound = {layout:null,path:null};
   var _rootNode = null;
   var _current = {name: null,layout: null,params:null,queryParams:null};

   /*****************************************************
   Will reset the router to uninitialized state.
      Useful when using router inside of an application that has another router.
   ******************************************************/
   this.reset = function(){
      _routes = {};
      _notFound = {layout:null,path:null};
      _rootNode = null;
      _current = {name: null,layout: null,params:null,queryParams:null};
   };

   /*****************************************************
   Initialize the router
      Must be called in initialization scripts once all routes have been added,
      and once all components have been defined
   ******************************************************/
   this.initialize = function(nodeId) {
      //bind change events for back and forward buttons
      window.addEventListener('popstate',_renderLayoutFromBrowserURL);

      //mount router root component
      var rootNode = document.createElement('router-root-node');
      var bodyNode = document.getElementById(nodeId);
      bodyNode.appendChild(rootNode);
      _rootNode = rootNode;

      //get the current route from url and render route layout
      _renderLayoutFromBrowserURL();
   };

   /*****************************************************
   Retrieve the current active route
      #return {string}: current route name
   ******************************************************/
   this.currentRoute = function() {
      return _current.name;
   };

   /*****************************************************
   Register a route with the router
      @name {string}: route name
      @path {string}: route path definition
      @layout {string}: route layout component
      @components {object}: layout subcomponent definitions
   ******************************************************/
   this.route = function(name,path,layout,components) {
      //create route info object
      var routeInfo = {
         path: path,
         layout: layout
      };
      if(components){
         routeInfo.components = components;
      }
      //save to internal route dictionairy
      _routes[name] = routeInfo;
   };

   /*****************************************************
   Navigate to a route
      @routeName {string}: route name
      @params {object}: route path parameters
      @queryParams {object}: route path queryParameters
   ******************************************************/
   this.go = function(routeName,params,queryParams) {
      //Check for valid route name
      if(!_routes[routeName]){
         return _redirectToNotFound();
      }
      var route = _routes[routeName];
      var path = route.path;
      //Get the path params
      if(params){
         var paramData = _injectParamsIntoPath(path,params,queryParams,routeName);
         _current.params = paramData.params;
         _current.queryParams = paramData.queryParams;
         path = paramData.path;
      }

      //save and change route
      history.pushState(null,null,path);
      _current.name = routeName;

      //render route layout
      _renderLayout(route.layout,route.components);
   };

   /*****************************************************
   Get a path parameter value
      @paramName {string}: name of route parameter
      #return {string}: route parameter value
   ******************************************************/
   this.getParam = function(paramName) {
      var value = _current.params[paramName];
      if(value === undefined){
        // throw new Error('Paramter "' + paramName + '" doesn\'t exist on current route');
      }
      else{
         return value;
      }
   };

   /*****************************************************
   Changes the current routes parameters
      @newParams {object}: new route parameters
   ******************************************************/
   this.setParams = function(newParams) {
      var paramData = _injectParamsIntoPath(_routes[_current.name].path,newParams,_current.queryParams,_current.name);
      _current.params = paramData.params;

      //save and change route
      history.pushState(null,null,paramData.path);

      //render route layout
      _renderLayout(_routes[_current.name].layout,_routes[_current.name].components);
   };

   /*****************************************************
   Get a path query parameter value
      @queryParamName {string}: name of route query parameter
      #return {string}: route query parameter value
   ******************************************************/
   this.getQueryParam = function(queryParamName) {
      var value = _current.queryParams[queryParamName];
      if(value === undefined){
         //throw new Error('Query Parameter "' + queryParamName + '" doesn\'t exist on current route');
      }
      else{
         return value;
      }
   };

   /*****************************************************
   Changes the current routes query parameters
      @newParams {object}: new route query parameters
   ******************************************************/
   this.setQueryParams = function(newQueryParams) {
      var paramData = _injectParamsIntoPath(_routes[_current.name].path,_current.params,newQueryParams,_current.name);
      _current.queryParams = paramData.queryParams;

      //save and change route
      history.pushState(null,null,paramData.path);

      //render route layout
      _renderLayout(_routes[_current.name].layout,_routes[_current.name].components);
   };

   /*****************************************************
   Register a layout to handle not found route
      @path {string}: route path definition
      @layout {string}: route layout component
   *****************************************************/
   this.notFound = function(path,layout) {
      _notFound.path = path;
      _notFound.layout = layout;
   };

   /*****************************************************
   Renders a Layout from a browser URL
   *****************************************************/
   var _renderLayoutFromBrowserURL = function(){
      //Get the route data from the URL
      var routeData = _parseUrlForRoute();
      if(!routeData){
         return _redirectToNotFound();
      }
      _current.name = routeData.name;

      //check for route parameters
      _current.params = routeData.params;
      _current.queryParams = routeData.queryParams

      //load the layout
      _renderLayout(_routes[routeData.name].layout,_routes[routeData.name].components);
   };

   /*****************************************************
   Gets route data from a browser URL
      #return {object}: parsed route data
         #name {string}: parsed route name
         #params {object}: parsed URL parameters for route
   *****************************************************/
   var _parseUrlForRoute = function(){
      var path = window.location.pathname + window.location.hash;
      return _matchPathToRouteName(path,true);
   };

   /*****************************************************
   Converts a route path definition and params into a browser URL path
      @path {string}: route path definition
      @params {object}: route path parameters
      @params {string}: route name
      #return {object}: route path data
         #path {string}: converted browser URL path
         #params {object}: actual injected parameters based on path definition
   *****************************************************/
   var _injectParamsIntoPath = function(path,params,queryParams,routeName){
      //parse route path definition for parameterized segements
      var urlRegEx = /:[^\s/]+/g;
      var pathParams = path.match(urlRegEx);
      var convertedPath = path;
      var convertedParams = {};
      var convertedQueryParams = {};
      if(pathParams){
         //iterate over parameterized segements
         for(var i=0;i<pathParams.length;i++){
            //isolate the path parameter
            var parameter = pathParams[i].replace(':','');
            var value = params[parameter];
            if(value === undefined){
               throw new Error('Parameter "' + parameter + '" not found on route: ' + routeName);
            }
            else{
               //replace the path parameter with parameter value
               convertedParams[parameter] = String(value);

               convertedPath = convertedPath.replace(pathParams[i],value);
            }
         }
      }
      //check for query Paramaters
      if(queryParams && Object.keys(queryParams).length > 0){
         //build the query params string
         convertedPath += '?'
         var queryParamKeys = Object.keys(queryParams)
         for(var j=0;j<queryParamKeys.length;j++){
            convertedPath += queryParamKeys[j] + '=' + queryParams[queryParamKeys[j]];
            convertedQueryParams[queryParamKeys[j]] = queryParams[queryParamKeys[j]]
            if(j !== queryParamKeys.length-1){
               convertedPath+= '&';
            }
         }
      }
      return {path:convertedPath,params:convertedParams,queryParams:convertedQueryParams};
   };

   /*****************************************************
   Find a route name from a browser URL path by matching with a route path definition
      @path {string}: Browser URL Path
      #return {object}: parsed route data
         #name {string}: parsed route name
         #params {object}: parsed URL parameters for route
   *****************************************************/
   var _matchPathToRouteName = function(path,fullParse){
      //split url path segements
      var matches = [];
      var urlRegEx = /:[^\s/]+/g;
      var urlPathSegments = path.split('/');

      for(var routeName in _routes){
         //split route path definitions into segements
         var routePathSegments = _routes[routeName].path.replace(urlRegEx,'*').split('/');

         //search for matches between the url path segements and the route path definition segements
         if(routePathSegments.length === urlPathSegments.length){
            var matchFound = false;
            var params = {};
            for(var i=0;i<routePathSegments.length;i++){
               var segement = routePathSegments[i];
               //check for a match
               if(segement === '*' || routePathSegments[i] === urlPathSegments[i]){
                  if(segement === '*'){
                     //add the URL parameter value to parameter object
                     var property = _routes[routeName].path.split('/')[i].replace(':','');
                     params[property] = urlPathSegments[i];
                  }
                  if(i === routePathSegments.length -1){
                     //if matches have found and is the last segement we have found a route match
                     matchFound = true;
                  }
               }
               else{
                  //check the next route because a match was not found
                  break;
               }
            }
            if(matchFound){
               //add matched route
               matches.push({name: routeName,params:params});
            }
         }
      }

      if(matches.length === 1){
        var match = matches[0];
        match.queryParams = {};
        if(fullParse){
          var searchParamRegex =  /([^?=&]+)(=([^&]*))?/g;
          for(var param in match.params){
            var paramGroup = match.params[param].match(searchParamRegex);
            if(paramGroup.length > 1){
              for(var i=0;i<paramGroup.length;i++){
                if(i===0){
                  match.params[param] = paramGroup[i];
                }
                else{
                  var searchParam = paramGroup[i].split('=')
                  match.queryParams[searchParam[0]] = searchParam[1];
                }
              }

            }
          }
        }
        return match;
      }

      //Handle no matches
      if(matches.length === 0){
         _redirectToNotFound();
      }

      //Handle multiple matches
      if(matches.length > 1){
         var matchedRoutes = '';
         for(var i=0;i<matches.length;i++){
            matchedRoutes +=matches[i] + ' ';
         }
         throw new Error('Non-unique route signatures detected for routes: ' + matchedRoutes);
      }
   };

   /*****************************************************
   Renders a given polymer route layout
      @layout {string}: Name of polymer layout component
      @components {object}: layout subcomponent definitions
   *****************************************************/
   var _renderLayout = function(layout, components){
      //create the layout component
      var layoutComponent = document.createElement(layout);

      //append the layout's components onto the layout component
      if(components){
         for(var key in components){
            layoutComponent[key] = document.createElement(components[key]);
         }
      }

      //remove the old layout
      if(_current.layout){
         Polymer.dom(_rootNode).removeChild(_current.layout);
      }

      //mount the new layout
      Polymer.dom(_rootNode).appendChild(layoutComponent);
      _current.layout = layoutComponent;
   };

   /*****************************************************
   Redirects to not found route
   *****************************************************/
   var _redirectToNotFound = function(){
      //check if not found route has been defined
      if(!_notFound.layout){
        // throw new Error('Route not found for path: ' + path);
      }
      else{
        //change the URL path if it is defined
         var path = _notFound.path
         if(path){
            history.pushState(null,null,path);
         }

         _current.name = 'notFound';
         _current.params = null;
         _current.queryParams = null;

         //render route layout
         _renderLayout(_notFound.layout);
      }
   }
};
//Expose global router object
var Router = new Router();

</script>
